import tkinter as tk
from tkinter import ttk, messagebox
import json
import os

# ==========================================================
# SISTEMA DE CONTROLE DE ESTOQUE COMPLETO (v3)
# Agora com: persist√™ncia + baixa de estoque + relat√≥rios
# ==========================================================

ARQUIVO_ESTOQUE = "estoque.json"

# ----------------------------------------------------------
# Fun√ß√µes para salvar e carregar dados
# ----------------------------------------------------------
def carregar_estoque():
    if os.path.exists(ARQUIVO_ESTOQUE):
        try:
            with open(ARQUIVO_ESTOQUE, "r", encoding="utf-8") as f:
                return json.load(f)
        except json.JSONDecodeError:
            messagebox.showwarning("Erro", "Arquivo de dados corrompido. Criando novo estoque...")
            return []
    return []

def salvar_estoque():
    with open(ARQUIVO_ESTOQUE, "w", encoding="utf-8") as f:
        json.dump(estoque, f, indent=4, ensure_ascii=False)

# ----------------------------------------------------------
# Carrega o estoque salvo
# ----------------------------------------------------------
estoque = carregar_estoque()

# ----------------------------------------------------------
# Atualiza tabela
# ----------------------------------------------------------
def atualizar_tabela(tabela, filtro=None):
    tabela.delete(*tabela.get_children())
    for produto in estoque:
        if not filtro or filtro.lower() in produto["nome"].lower() or filtro.lower() in produto["codigo"].lower():
            tabela.insert("", "end", values=(produto["codigo"], produto["nome"], produto["quantidade"]))

# ----------------------------------------------------------
# JANELA: Cadastro
# ----------------------------------------------------------
def janela_cadastro():
    cadastro = tk.Toplevel(root)
    cadastro.title("üì¶ Cadastro de Produtos")
    cadastro.geometry("480x350")
    cadastro.configure(bg="#f4f7ff")

    tk.Label(cadastro, text="CADASTRAR PRODUTO", font=("Arial", 15, "bold"), bg="#3F51B5", fg="white", pady=10).pack(fill="x")

    frame = tk.Frame(cadastro, bg="#f4f7ff")
    frame.pack(pady=20)

    tk.Label(frame, text="C√≥digo:", bg="#f4f7ff", font=("Arial", 11)).grid(row=0, column=0, padx=5, pady=5)
    e_codigo = tk.Entry(frame, width=30)
    e_codigo.grid(row=0, column=1, padx=5, pady=5)

    tk.Label(frame, text="Nome:", bg="#f4f7ff", font=("Arial", 11)).grid(row=1, column=0, padx=5, pady=5)
    e_nome = tk.Entry(frame, width=30)
    e_nome.grid(row=1, column=1, padx=5, pady=5)

    tk.Label(frame, text="Quantidade:", bg="#f4f7ff", font=("Arial", 11)).grid(row=2, column=0, padx=5, pady=5)
    e_qtd = tk.Entry(frame, width=30)
    e_qtd.grid(row=2, column=1, padx=5, pady=5)

    def salvar_produto():
        codigo = e_codigo.get().strip()
        nome = e_nome.get().strip()
        qtd = e_qtd.get().strip()

        if not codigo or not nome or not qtd:
            messagebox.showwarning("‚ö†Ô∏è", "Preencha todos os campos!")
            return

        if any(p["codigo"] == codigo for p in estoque):
            messagebox.showerror("Erro", "J√° existe um produto com esse c√≥digo!")
            return

        try:
            qtd = int(qtd)
        except ValueError:
            messagebox.showerror("Erro", "Quantidade inv√°lida!")
            return

        estoque.append({"codigo": codigo, "nome": nome, "quantidade": qtd})
        salvar_estoque()
        e_codigo.delete(0, tk.END)
        e_nome.delete(0, tk.END)
        e_qtd.delete(0, tk.END)
        messagebox.showinfo("‚úÖ", f"Produto '{nome}' cadastrado com sucesso!")

    tk.Button(cadastro, text="Salvar Produto", bg="#4CAF50", fg="white", font=("Arial", 11, "bold"), width=18, command=salvar_produto).pack(pady=10)
    tk.Button(cadastro, text="Fechar", bg="#9E9E9E", fg="white", width=18, command=cadastro.destroy).pack()

# ----------------------------------------------------------
# JANELA: Dar Baixa no Estoque
# ----------------------------------------------------------
def janela_baixa():
    baixa = tk.Toplevel(root)
    baixa.title("üìâ Dar Baixa no Estoque")
    baixa.geometry("480x300")
    baixa.configure(bg="#f4f7ff")

    tk.Label(baixa, text="DAR BAIXA NO ESTOQUE", font=("Arial", 15, "bold"), bg="#9C27B0", fg="white", pady=10).pack(fill="x")

    frame = tk.Frame(baixa, bg="#f4f7ff")
    frame.pack(pady=20)

    tk.Label(frame, text="C√≥digo do produto:", bg="#f4f7ff").grid(row=0, column=0, padx=5, pady=5)
    e_codigo = tk.Entry(frame, width=30)
    e_codigo.grid(row=0, column=1)

    tk.Label(frame, text="Quantidade a dar baixa:", bg="#f4f7ff").grid(row=1, column=0, padx=5, pady=5)
    e_qtd = tk.Entry(frame, width=30)
    e_qtd.grid(row=1, column=1)

    def dar_baixa():
        codigo = e_codigo.get().strip()
        qtd = e_qtd.get().strip()

        if not codigo or not qtd:
            messagebox.showwarning("‚ö†Ô∏è", "Preencha todos os campos!")
            return

        try:
            qtd = int(qtd)
        except ValueError:
            messagebox.showerror("Erro", "Quantidade inv√°lida!")
            return

        for p in estoque:
            if p["codigo"] == codigo:
                if p["quantidade"] >= qtd:
                    p["quantidade"] -= qtd
                    salvar_estoque()
                    messagebox.showinfo("‚úÖ", f"Baixa realizada com sucesso!\nNovo estoque: {p['quantidade']}")
                else:
                    messagebox.showwarning("Erro", "Quantidade em estoque insuficiente!")
                break
        else:
            messagebox.showerror("Erro", "Produto n√£o encontrado!")

    tk.Button(baixa, text="Confirmar Baixa", bg="#9C27B0", fg="white", width=18, command=dar_baixa).pack(pady=10)
    tk.Button(baixa, text="Fechar", bg="#9E9E9E", fg="white", width=18, command=baixa.destroy).pack()

# ----------------------------------------------------------
# JANELA: Consulta / Pesquisa
# ----------------------------------------------------------
def janela_consulta():
    consulta = tk.Toplevel(root)
    consulta.title("üîç Consulta de Produtos")
    consulta.geometry("600x400")
    consulta.configure(bg="#f4f7ff")

    tk.Label(consulta, text="CONSULTAR PRODUTOS", font=("Arial", 15, "bold"), bg="#2196F3", fg="white", pady=10).pack(fill="x")

    frame_busca = tk.Frame(consulta, bg="#f4f7ff")
    frame_busca.pack(pady=10)

    tk.Label(frame_busca, text="Pesquisar:", bg="#f4f7ff").grid(row=0, column=0, padx=5)
    entrada_pesquisa = tk.Entry(frame_busca, width=30)
    entrada_pesquisa.grid(row=0, column=1, padx=5)

    colunas = ("C√≥digo", "Nome", "Quantidade")
    tabela = ttk.Treeview(consulta, columns=colunas, show="headings")
    for c in colunas:
        tabela.heading(c, text=c)
    tabela.pack(fill="both", expand=True, pady=10)

    atualizar_tabela(tabela)

    tk.Button(frame_busca, text="Pesquisar", bg="#2196F3", fg="white", command=lambda: atualizar_tabela(tabela, entrada_pesquisa.get())).grid(row=0, column=2, padx=5)
    tk.Button(consulta, text="Fechar", bg="#9E9E9E", fg="white", width=18, command=consulta.destroy).pack(pady=5)

# ----------------------------------------------------------
# JANELA: Relat√≥rio de Estoque Baixo
# ----------------------------------------------------------
def janela_estoque_baixo():
    relatorio = tk.Toplevel(root)
    relatorio.title("‚ö†Ô∏è Estoque Baixo")
    relatorio.geometry("500x350")
    relatorio.configure(bg="#fff8f0")

    tk.Label(relatorio, text="PRODUTOS COM ESTOQUE BAIXO", font=("Arial", 15, "bold"), bg="#FF9800", fg="white", pady=10).pack(fill="x")

    colunas = ("C√≥digo", "Nome", "Quantidade")
    tabela = ttk.Treeview(relatorio, columns=colunas, show="headings")
    for c in colunas:
        tabela.heading(c, text=c)
    tabela.pack(fill="both", expand=True, pady=10)

    for p in estoque:
        if p["quantidade"] <= 5:
            tabela.insert("", "end", values=(p["codigo"], p["nome"], p["quantidade"]))

    tk.Button(relatorio, text="Fechar", bg="#9E9E9E", fg="white", width=18, command=relatorio.destroy).pack(pady=10)

# ----------------------------------------------------------
# JANELA: Relat√≥rio Geral
# ----------------------------------------------------------
def janela_relatorio_geral():
    relatorio = tk.Toplevel(root)
    relatorio.title("üìã Relat√≥rio Geral")
    relatorio.geometry("600x400")
    relatorio.configure(bg="#f4f7ff")

    tk.Label(relatorio, text="RELAT√ìRIO GERAL DO ESTOQUE", font=("Arial", 15, "bold"), bg="#607D8B", fg="white", pady=10).pack(fill="x")

    colunas = ("C√≥digo", "Nome", "Quantidade")
    tabela = ttk.Treeview(relatorio, columns=colunas, show="headings")
    for c in colunas:
        tabela.heading(c, text=c)
    tabela.pack(fill="both", expand=True, pady=10)

    for p in estoque:
        tabela.insert("", "end", values=(p["codigo"], p["nome"], p["quantidade"]))

    tk.Button(relatorio, text="Fechar", bg="#9E9E9E", fg="white", width=18, command=relatorio.destroy).pack(pady=10)

# ----------------------------------------------------------
# TELA PRINCIPAL
# ----------------------------------------------------------
root = tk.Tk()
root.title("üìä Sistema de Controle de Estoque")
root.geometry("480x480")
root.configure(bg="#E3F2FD")

tk.Label(root, text="SISTEMA DE ESTOQUE", font=("Arial", 16, "bold"), bg="#1976D2", fg="white", pady=12).pack(fill="x")

frame_botoes = tk.Frame(root, bg="#E3F2FD")
frame_botoes.pack(expand=True, pady=20)

tk.Button(frame_botoes, text="üì¶ Cadastrar Produto", bg="#4CAF50", fg="white", font=("Arial", 12, "bold"), width=25, command=janela_cadastro).pack(pady=6)
tk.Button(frame_botoes, text="üìâ Dar Baixa", bg="#9C27B0", fg="white", font=("Arial", 12, "bold"), width=25, command=janela_baixa).pack(pady=6)
tk.Button(frame_botoes, text="üîç Consultar Produtos", bg="#2196F3", fg="white", font=("Arial", 12, "bold"), width=25, command=janela_consulta).pack(pady=6)
tk.Button(frame_botoes, text="‚ö†Ô∏è Estoque Baixo", bg="#FF9800", fg="white", font=("Arial", 12, "bold"), width=25, command=janela_estoque_baixo).pack(pady=6)
tk.Button(frame_botoes, text="üìã Relat√≥rio Geral", bg="#607D8B", fg="white", font=("Arial", 12, "bold"), width=25, command=janela_relatorio_geral).pack(pady=6)
tk.Button(frame_botoes, text="üö™ Sair", bg="#E53935", fg="white", font=("Arial", 12, "bold"), width=25, command=root.destroy).pack(pady=6)

tk.Label(root, text="¬© 2025 - Sistema de Estoque | Python üêç", bg="#1976D2", fg="white", pady=6).pack(fill="x", side="bottom")

root.mainloop()
